schema_version: 2

# Metadata
id: "ohy35k"
source_events:
  - "da04cc" # command-module-coupling.yml
  - "d4e5f6" # hardcoded-env-dependencies.yml
  - "da03is" # implicit-storage-config.yml
  - "dupv01" # duplicate-path-validation.yml
  - "perf01" # inefficient-snippet-resolution.yml
  - "ev2prj" # project-root-detection.yml
  - "d0i2m5" # redundant-outcome-types.yml
  - "da01rs" # redundant-snippet-models.yml
  - "da05le" # lossy-error-types.yml
  - "err001" # stringly-typed-errors.yml
  - "da02dl" # dead-list-entry-fields.yml
  - "g7h8i9" # missing-unit-tests-lib.yml
  - "a1b2c3" # test-redundancy-touch.yml
title: "Core Architecture Refactor"
label: "refacts"
priority: "high"
summary: "Decouple core modules, modernize data models, and improve error handling to enable better testing and maintainability."

# Content
problem: |
  The core codebase suffers from significant technical debt including:
  1. **Circular & Hidden Coupling**: `src/commands/copy_snippet.rs` imports `validate_path` from `src/commands/touch.rs`, creating a hidden dependency. Library functions in `lib.rs` depend on `touch::find_project_root`.
  2. **Implicit Environment State**: `SnippetStorage::from_env` and `clipboard_from_env` hardcode `MX_COMMANDS_ROOT` and `HOME` reads, making unit testing impossible without env manipulation.
  3. **Redundant Data Models**: `SnippetFile` (storage) and `CopyOutcome` (command) are structurally identical but distinct types, preventing code reuse.
  4. **Duplicated & Inconsistent Logic**: Path validation exists in both `storage.rs` (string-based) and `touch.rs` (component-based). Project root detection (`find_project_root`) is naive (cwd only).
  5. **Stringly-Typed Errors**: `AppError` uses `String` variants (`ConfigError(String)`), losing type information and preventing programmatic error handling.
  6. **Inefficient Resolution**: `resolve_snippet` performs a full directory walk (O(N)) for every lookup.

impact: |
  These issues make the codebase fragile, difficult to test, and hard to extend. The lack of unit tests increases the risk of regressions. The inefficient snippet resolution scales poorly. The coupling prevents clean separation of concerns, making it hard to add new commands without entangling them with `touch`.

desired_outcome: |
  A clean, decoupled architecture where:
  1. **Shared Utilities**: Create `src/utils/` for shared logic:
     - `src/utils/path.rs`: Centralize `validate_path`, `resolve_path` (from `touch.rs`).
     - `src/utils/fs.rs`: Centralize `find_project_root` (improved to walk up tree).
  2. **Dependency Injection**: Refactor `SnippetStorage` to accept a `root: PathBuf` in its constructor. Move env var loading to `main.rs`.
  3. **Unified Models**: Move `SnippetFile` to `src/models.rs` (or `lib.rs`) and use it in `CopyOutcome` (or replace `CopyOutcome`).
  4. **Typed Errors**: Add `thiserror` crate. Refactor `AppError` to use typed variants (e.g., `#[error("Snippet {0} not found")] SnippetNotFound(String)`).
  5. **Optimized Storage**: Optimize `resolve_snippet` (e.g., check exact path first before walking).
  6. **Testability**: Ensure all public functions in `lib.rs` and `storage.rs` are unit-testable without filesystem/env side effects (using `tempfile` and injected paths).

constraints: []
risks:
  - **CLI Compatibility**: Changes to error messages (due to `thiserror`) might affect scripts parsing stderr.
  - **Path Validation**: Unifying path validation might reject paths that were previously allowed by one of the divergent implementations.

# Specifics
affected_areas:
  - "Cargo.toml"
  - "src/lib.rs"
  - "src/error.rs"
  - "src/storage.rs"
  - "src/commands/touch.rs"
  - "src/commands/copy_snippet.rs"
  - "src/commands/cat.rs"
  - "src/utils/" # New module

acceptance_criteria:
  - "`SnippetStorage` struct has no `from_env` method (or it is moved to a factory in `main`)."
  - "`src/commands/copy_snippet.rs` does not import from `src/commands/touch.rs`."
  - "`AppError` implements `thiserror::Error`."
  - "`SnippetFile` is reused or unified with `CopyOutcome`."
  - "Path validation logic exists in exactly one place."
  - "Unit tests cover >90% of `src/storage.rs` and `src/utils/`."

verification_commands:
  - "cargo test"
  - "cargo clippy --all-targets --all-features -- -D warnings"

# Analysis Flags
requires_deep_analysis: false
deep_analysis_reason: "This refactor touches almost every file in the `src` directory and changes core interfaces. A detailed plan for dependency injection and error handling migration is needed to avoid breaking the world. Analysis confirmed: 1. `copy_snippet` depends on `touch` for `validate_path`. 2. `SnippetStorage` reads env vars. 3. `SnippetFile` and `CopyOutcome` are redundant. 4. `AppError` is string-based. 5. `resolve_snippet` is O(N)."
