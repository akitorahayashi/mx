# .jules/

The `.jules/` directory is a structured workspace for scheduled agents and human execution.
It captures **observations as events** and **actionable work as issues** within workstreams.

This file is human-oriented. Agents must read `.jules/JULES.md` for the formal contract.

## Scope (What this README defines)

- `.jules/` defines **artifacts and contracts** (events/issues, role state, schemas).
- **Execution + git + PR operations are out of scope here.**
  When you are reading this inside the VM, you already have the execution environment;
  follow the role contract and produce the required artifacts/changes.
- `jlo` is **scaffold + prompt/config management only**.
  It does **not** run agents, orchestrate schedules, create PRs, or manage merges.

## Document Hierarchy

| Document | Audience | Contains |
|----------|----------|----------|
| `.jules/JULES.md` | Jules agents | Jules-specific contracts and schemas |
| `.jules/README.md` | Humans | This guide |

**Rule**: Jules-internal details stay in `.jules/`.

## Role Flow

```
Narrator -> Observer -> Decider -> [Planner] -> Implementer
(changes)   (events)    (issues)   (expand)     (code changes)
```

| Role Type | Role(s) | Transformation |
|-----------|---------|----------------|
| Narrator | `.jules/roles/narrator/` | Git history -> Changes summary |
| Observer | directories under `.jules/roles/observers/` | Source -> Events (domain-specialized observations) |
| Decider | directories under `.jules/roles/deciders/` | Events -> Issues (validation + consolidation) |
| Planner | directories under `.jules/roles/planners/` | Issues -> Expanded Issues (deep analysis, optional) |
| Implementer | directories under `.jules/roles/implementers/` | Issues -> Code changes |

**Execution**: Roles are invoked by GitHub Actions using `jlo run` and workflow dispatch workflows.

**Configuration Language**: All YAML files are written in English for optimal LLM processing.

## Branch Strategy

| Agent Type | Starting Branch | Output Branch | Auto-merge |
|------------|-----------------|---------------|------------|
| Narrator | `jules` | `jules-narrator-*` | ✅ (if `.jules/` only) |
| Observer | `jules` | `jules-observer-*` | ✅ (if `.jules/` only) |
| Decider | `jules` | `jules-decider-*` | ✅ (if `.jules/` only) |
| Planner | `jules` | `jules-planner-*` | ✅ (if `.jules/` only) |
| Implementer | `main` | `jules-implementer-*` | ❌ (human review) |

Narrator, Observers, Deciders, and Planners modify only `.jules/` and auto-merge after CI passes.
Implementers modify source code and require human review.

## Directory Structure

```
.jules/
+-- README.md           # This file (jlo-managed)
+-- JULES.md            # Agent contract (jlo-managed)
+-- .jlo-version        # Version marker (jlo-managed)
|
+-- changes/            # Narrator output
|   +-- latest.yml      # Current change summary (generated by Narrator)
|
+-- workstreams/        # Workstream containers
|   +-- <workstream>/   # e.g. generic/
|       +-- exchange/   # Exchange container
|       |   +-- events/     # Raw observations
|       |   |   +-- <state>/
|       |   |       +-- *.yml
|       |   +-- issues/     # Consolidated problems
|       |       +-- index.md
|       |       +-- <label>/
|
+-- roles/              # Role definitions (global)
    +-- narrator/       # Single-role layer
    |   +-- contracts.yml    # Narrator contract
    |   +-- prompt.yml       # Run prompt
    |   +-- change.yml       # Schema template for latest.yml
    |
    +-- observers/      # Multi-role layer
    |   +-- contracts.yml    # Shared observer contract
    |   +-- event.yml        # Event template
    |   +-- <role>/          # Role subdirectory
    |       +-- prompt.yml   # Static: run prompt (includes workstream)
    |       +-- role.yml     # Dynamic: evolving focus
    |       +-- feedbacks/   # Decider feedback
    |
    +-- deciders/       # Multi-role layer
    |   +-- contracts.yml    # Shared decider contract
    |   +-- issue.yml        # Issue template
    |   +-- feedback.yml     # Feedback template
    |   +-- <role>/          # Role subdirectory
    |       +-- prompt.yml   # Includes workstream
    |
    +-- planners/       # Single-role layer (issue-driven)
    |   +-- contracts.yml    # Shared planner contract
    |   +-- prompt.yml       # Direct prompt (no subdirectory)
    |
    +-- implementers/   # Single-role layer (issue-driven)
        +-- contracts.yml    # Shared implementer contract
        +-- prompt.yml       # Direct prompt (no subdirectory)
```

## Layer Architecture

| Layer | Type | Invocation |
|-------|------|------------|
| Narrator | Single-role | `jlo run narrator` |
| Observers | Multi-role | `jlo run observers --workstream <name> --scheduled` |
| Deciders | Multi-role | `jlo run deciders --workstream <name> --scheduled` |
| Planners | Single-role | `jlo run planners <path>` |
| Implementers | Single-role | `jlo run implementers <path>` |

**Narrator**: Produces `.jules/changes/latest.yml` summarizing recent codebase changes. Runs first, before observers.

**Multi-role layers** (Observers, Deciders): Roles are scoped to workstreams and scheduled via `workstreams/<workstream>/scheduled.toml`. Each role has its own subdirectory with `prompt.yml`. Custom roles can be created with `jlo template`.

**Single-role layers** (Planners, Implementers): Have a fixed role with `prompt.yml` directly in the layer directory. They are issue-driven and require an issue file path argument. Template creation is not supported.

## Workstreams

Workstreams isolate events and issues so that decider rules do not mix across unrelated operational areas.

- A workstream may run observers only (no decider), leaving events for human review.
- `roles/` remains global (not nested per workstream).
- Observers and deciders declare their destination workstream in `prompt.yml`.
- If the workstream directory is missing, execution fails fast.
- Event state directories are defined by the scaffold templates.

The default scaffold creates a `generic` workstream.

## Configuration Files

### contracts.yml
Layer-level shared constraints and workflows. All roles in the layer reference this file.

### prompt.yml
Execution parameters and references to contracts.yml. Includes `workstream:` field for observers and deciders.

### role.yml
Specialized focus that evolves through feedback loop. Only observers have this (stateful layer).

### Templates (*.yml)
Copyable templates (change.yml, event.yml, issue.yml, feedback.yml) defining the structure of artifacts.
Agents `cp` these files and fill them out.

## Workflow

### 0. Narrator Agent (Scheduled, runs first)

Narrator summarizes codebase changes for observer context:
1. Reads `.jules/roles/narrator/change.yml` for schema
2. Determines commit range (previous `to_commit` or bootstrap)
3. Collects commits and changed paths (excluding `.jules/`)
4. Writes `.jules/changes/latest.yml`

If no non-excluded changes exist, Narrator exits without creating a session.

### 1. Observer Agents (Scheduled)

Each observer:
1. Reads contracts.yml (layer behavior)
2. Reads `.jules/changes/latest.yml` for recent changes context (if present)
3. Reads role.yml (specialized focus)
4. Reads feedbacks/, abstracts patterns, updates role.yml
5. **Reads .jules/workstreams/<workstream>/exchange/issues/index.md to check for open issues**
6. **Skips observations already covered by open issues (deduplication)**
7. Writes event files under workstreams/<workstream>/exchange/events/ in the incoming state directory
8. Publishes changes as a PR (branch naming follows the convention below)

**Stateful**: Receives feedback via `feedbacks/`.

### 2. Decider Agent (Scheduled)

Triage agent:
1. Reads contracts.yml (layer behavior)
2. Reads all event files in the workstream incoming state directory
3. **Reads .jules/workstreams/<workstream>/exchange/issues/index.md and existing issues to identify merge candidates**
4. Validates observations (do they exist in codebase?)
5. Merges related events sharing root cause
6. **Merges events into existing issues when related (updates content)**
7. Creates new issues for genuinely new problems (using id as filename, placing in label folder)
8. **Updates .jules/workstreams/<workstream>/exchange/issues/index.md**
9. **When deep analysis is needed, provides clear rationale in deep_analysis_reason**
10. Writes feedback for recurring rejections
11. Moves processed events to the processed state directory defined by the scaffold

**Decider answers**: "Is this real? Should these events merge into one issue?"

### 3. Planner Agent (On-Demand)

Specifier agent (runs only for `requires_deep_analysis: true`):
1. Reads contracts.yml (layer behavior)
2. Reads target issue from workstreams/<workstream>/exchange/issues/<label>/
3. **Reviews deep_analysis_reason to understand scope**
4. Analyzes full system impact and dependency tree
5. Expands issue with detailed analysis (affected_areas, constraints, risks)
6. Sets requires_deep_analysis to false
7. **Preserves and expands the original rationale with findings**
8. Overwrites the issue file

**Planner answers**: "What is the full scope of this issue?"

### 4. Implementation (Via Local Issue)

Implementation is invoked via workflow dispatch with a local issue file path. Scheduled workflows may also dispatch implementers based on repository policy.

```bash
# Example: Run implementer with a specific issue
jlo run implementers .jules/workstreams/generic/exchange/issues/<label>/auth-inconsistency.yml
```

The implementer reads the issue content (embedded in prompt) and produces code changes.
The issue file must exist; missing files fail fast before agent execution.

**Issue Lifecycle**:
1. An issue file is selected from `.jules/workstreams/<workstream>/exchange/issues/<label>/` on the `jules` branch.
2. The workflow validates the file exists and passes content to the implementer.
3. Issue file retention or deletion is handled by the dispatching workflow policy.
4. The implementer works on the default code branch and creates a PR for human review.
5. The `sync-jules.yml` workflow keeps `jules` in sync with the default branch after merges.

## Feedback Loop

```
Observer creates events in workstreams/<workstream>/exchange/events/<state>/
       |
       v
Decider validates, may reject or merge
       |
       v (rejection)
Decider writes feedbacks/{date}_{desc}.yml
       |
       v
Observer reads feedbacks/, updates role.yml
       |
       v
Observer avoids similar observations
```

Feedback files are preserved for audit (never deleted).

## Issue Lifecycle

- Issues are organized by label directories defined by the scaffold and tracked in `index.md`.
- Open issues suppress duplicate observations from observers.
- Issue filenames use stable kebab-case identifiers (for example, `auth-inconsistency.yml`).
- Related events are merged into existing issues, not duplicated.

## Branch Naming Convention

All agents must create branches using this format:

```
jules-narrator-<id>
jules-observer-<id>
jules-decider-<id>
jules-planner-<id>
jules-implementer-<id>-<short_description>
```

## Testing and Validation

Workflows validate workstreams with `jlo doctor` after each layer execution to detect structural regressions early.

## Pause/Resume

Set the repository pause variable referenced by the workflows to skip scheduled runs.
The default behavior is active; paused behavior is explicit and visible.
