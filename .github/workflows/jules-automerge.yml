# Jules Auto-Merge
#
# Validates Jules PRs with doctor check and enables auto-merge on success.
# Only applies when:
#   1. PR targets the jules branch
#   2. Head branch matches jules-{narrator,observer,decider,planner}-* pattern
#   3. All changed files are within .jules/ directory
#   4. Doctor validation passes
#
# Does NOT apply to:
#   - jules-implementer-* branches (implementation requires human review)
#   - Any PR that modifies files outside .jules/
#
# Flow:
#   1. Jules creates PR → doctor runs
#   2. Doctor fails → Jules detects, fixes, pushes
#   3. Doctor passes → auto-merge enabled → PR merges when status checks pass
#
# Prerequisites:
# - Repository Settings: Enable "Allow auto-merge"
# - Branch Protection: Require this workflow as status check

name: Jules Auto-Merge

on:
  pull_request:
    branches:
      - jules
    types: [opened, synchronize, reopened]

jobs:
  validate-and-automerge:
    # Only run for narrator/observer/decider/planner branches
    if: >-
      startsWith(github.head_ref, 'jules-narrator-') ||
      startsWith(github.head_ref, 'jules-observer-') ||
      startsWith(github.head_ref, 'jules-decider-') ||
      startsWith(github.head_ref, 'jules-planner-')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Validate with doctor
        run: |
          # Extract workstream from changed files
          workstreams=$(git diff --name-only origin/jules...HEAD | grep '^\.jules/workstreams/' | cut -d'/' -f3 | sort -u)
          
          if [ -z "$workstreams" ]; then
            echo "No workstream changes detected, running doctor for all workstreams"
            shopt -s nullglob
            for ws_dir in .jules/workstreams/*/; do
              ws=$(basename "$ws_dir")
              echo "::group::Doctor check for $ws"
              jlo doctor --workstream "$ws"
              echo "::endgroup::"
            done
          else
            for ws in $workstreams; do
              echo "::group::Doctor check for $ws"
              jlo doctor --workstream "$ws"
              echo "::endgroup::"
            done
          fi

      - name: Check scope (files within .jules/ only)
        id: scope
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          changed=$(gh api --paginate "/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files" --jq '.[].filename')
          
          non_jules=$(echo "$changed" | grep -v '^\.jules/' || true)
          
          if [ -n "$non_jules" ]; then
            echo "::warning::PR modifies files outside .jules/. Auto-merge skipped."
            echo "$non_jules"
            echo "in_scope=false" >> "$GITHUB_OUTPUT"
          else
            echo "All changes are within .jules/"
            echo "in_scope=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Enable auto-merge
        if: steps.scope.outputs.in_scope == 'true'
        env:
          GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}
          
          # Check if draft
          IS_DRAFT=$(gh pr view "$PR_NUMBER" --repo "$REPO" --json isDraft -q '.isDraft')
          if [ "$IS_DRAFT" = "true" ]; then
            echo "PR is a draft. Skipping auto-merge."
            exit 0
          fi
          
          # Check if auto-merge already enabled
          AUTO_MERGE=$(gh pr view "$PR_NUMBER" --repo "$REPO" --json autoMergeRequest -q '.autoMergeRequest')
          if [ "$AUTO_MERGE" != "null" ] && [ -n "$AUTO_MERGE" ]; then
            echo "Auto-merge is already enabled."
            exit 0
          fi
          
          echo "Enabling auto-merge..."
          for i in {1..5}; do
            if gh pr merge "$PR_NUMBER" --auto --squash --delete-branch --repo "$REPO"; then
              echo "✅ Auto-merge enabled successfully."
              exit 0
            fi
            echo "Attempt $i failed, retrying in 10s..."
            sleep 10
          done
          echo "❌ Failed to enable auto-merge after retries."
          exit 1
